<!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->

{% capture result_elem %}
<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">
  <a href="{url}">{title}</a>
  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">
    {categories}
    {tags}
  </div>
  <p>{snippet}</p>
</div>
{% endcapture %}

{% capture not_found %}<p class="mt-5">{{ site.data.locales[site.lang].search.no_results }}</p>{% endcapture %}

<script src="{{ site.data.assets[origin].search.js | relative_url }}"></script>

<script>
var searchInput = document.getElementById('search-input');
var currentQuery = '';

function scoreTitle(title, query) {
  if (!title || !query) {
    return 0;
  }

  var titleLower = title.toLowerCase();
  var queryLower = query.trim().toLowerCase();

  if (queryLower === '') {
    return 0;
  }

  if (titleLower === queryLower) {
    return 3;
  }

  if (titleLower.indexOf(queryLower) !== -1) {
    return 2;
  }

  var tokens = queryLower.split(/\s+/).filter(Boolean);
  if (tokens.length && tokens.every(function(token) { return titleLower.indexOf(token) !== -1; })) {
    return 1;
  }

  return 0;
}

searchInput.addEventListener('input', function(event) {
  currentQuery = event.target.value || '';
});

SimpleJekyllSearch({
  searchInput: searchInput,
  resultsContainer: document.getElementById('search-results'),
  json: '{{ '/assets/js/data/search.json' | relative_url }}',
  searchResultTemplate: '{{ result_elem | strip_newlines }}',
  noResultsText: '{{ not_found }}',
  limit: Number.MAX_SAFE_INTEGER,
  exclude: ['^__snippet__'],
  sortMiddleware: function(a, b) {
    return scoreTitle(b.title, currentQuery) - scoreTitle(a.title, currentQuery);
  },
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'snippet') {
      return value.replace(/^__snippet__/, '');
    }
  }
});
</script>
